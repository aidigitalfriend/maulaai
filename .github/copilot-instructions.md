# Copilot Instructions for One Last AI

- **Architecture**: Next.js 16 frontend in [frontend](frontend) and Express API/socket server in [backend/server-simple.js](backend/server-simple.js); root scripts run both (frontend on port 3100) with [package.json](package.json) `npm run dev` / `npm run start`.
- **Routing pattern**: New API endpoints live in [backend/routes](backend/routes) and mount via the centralized [backend/routes/api-router.js](backend/routes/api-router.js) under `/api`; keep rate-limit middleware (`rateLimiters` from [backend/lib/cache.js](backend/lib/cache.js)) applied and prefer placing endpoints behind the apiLimiter/authLimiter used there.
- **Middleware stack**: Requests pass through helmet, CORS (respect `ALLOWED_ORIGINS`), JSON body parsing, cookies, tracking middlewares from [backend/lib/tracking-middleware.js](backend/lib/tracking-middleware.js), then per-route rate limiting; preserve this order when adding middleware.
- **Real-time**: Socket.io server created in [backend/server-simple.js](backend/server-simple.js) and shares Express instance; ensure CORS origins stay in sync with HTTP CORS.
- **Database access**: Uses PostgreSQL via Prisma ORM. Schema defined in [backend/prisma/schema.prisma](backend/prisma/schema.prisma). Connection configured via `DATABASE_URL` environment variable. Use Prisma Client from [backend/lib/prisma.js](backend/lib/prisma.js) for database operations.
- **Database**: PostgreSQL via Prisma ORM. Schema in [backend/prisma/schema.prisma](backend/prisma/schema.prisma). Schema changes require `npx prisma db push` or migrations.
- **Caching & rate limits**: Shared Redis/in-memory cache manager and limiters are in [backend/lib/cache.js](backend/lib/cache.js); prefer the cache middleware instead of rolling custom per-route caches.
- **Feature routers**: Core routers include analytics, agents, subscriptions, chat, gamification, community, support, billing, careers, webinars, favorites, suggestions (see [backend/routes](backend/routes)); reuse these routers when extending features rather than adding new top-level mounts.
- **Health/status**: Health and status endpoints are `/health`, `/api/health`, and `/api/status` in [backend/server-simple.js](backend/server-simple.js); keep them lightweight and unauthenticated for probes.
- **Environment**: Backend expects `DATABASE_URL` (PostgreSQL), `REDIS_URL`, `ALLOWED_ORIGINS`, and provider keys (`OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `GEMINI_API_KEY`, etc.); dotenv is loaded at the top of [backend/server-simple.js](backend/server-simple.js).
- **Frontend runtime**: Next.js app in [frontend](frontend) uses Tailwind and Radix; lint/test via `npm run lint` and Playwright `npm run test` in [frontend/package.json](frontend/package.json).
- **Universal chat**: Core chat UI in [frontend/components/universal-chat](frontend/components/universal-chat) expects `/api/studio/chat` and canvas generation at `/api/canvas/generate`; Canvas overlay lives in [frontend/components/universal-chat/canvas-build](frontend/components/universal-chat/canvas-build) and is opened from `ChatRightPanel.tsx` / `EnhancedChatLayout.tsx`.
- **Marketplace library**: API marketplace logic (tool builder, plugin system, monetization) is centralized under [frontend/lib/marketplace](frontend/lib/marketplace); extend tools/plugins there instead of scattering marketplace logic.
- **Shared package link**: Both apps depend on the workspace package `ai-app-monorepo` (file:..) to share types/utilities; keep versions in sync across [package.json](package.json), [frontend/package.json](frontend/package.json), and [backend/package.json](backend/package.json).
- **Dev workflows**: For local work, run `npm install` at root then `npm run dev` (spawns frontend:3100 + backend watch). To run individually: `cd frontend && npm run dev` or `cd backend && npm run dev:watch`. Run `npx prisma generate` after schema changes.
- **Testing**: Frontend uses Playwright (`npm run test`, `npm run test:ui`); backend has no automated tests configured—manual verification via `/api/health` and route-specific checks is common.
- **Deployment**: Production expects Next.js `npm start` and backend `node server-simple.js` with env files; [ecosystem.config.cjs](ecosystem.config.cjs) documents the prod process names and ports. Run `npx prisma db push` to sync schema with production database.
- **Concurrency safeguards**: Respect existing rate limits and caching to avoid overload; keep expensive AI/provider calls behind rateLimiters.agent and cache results where sensible using [backend/lib/cache.js](backend/lib/cache.js).
- **API responses**: Standardized JSON shape on API router (`success`, `message`, optional `errors`)—mirror this when adding endpoints so frontend consumption stays consistent.
