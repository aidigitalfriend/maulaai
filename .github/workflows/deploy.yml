name: Deploy to EC2 (PM2)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for reference)
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 60m
          envs: APP_DIR
          script: |
            set -euo pipefail

            APP_DIR=${APP_DIR:-/home/ubuntu/shiny-friend-disco}
            REPO_URL="https://github.com/aidigitalfriend/shiny-friend-disco.git"

            echo "==> Ensuring application directory exists: $APP_DIR"
            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$(dirname "$APP_DIR")"
              if [ -d "$APP_DIR" ]; then
                rm -rf "$APP_DIR"
              fi
              git clone "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"
            echo "==> Pulling latest code"
            git fetch --all
            git checkout main
            git pull --ff-only origin main

            echo "==> Ensuring Node & PM2 are installed"
            if ! command -v node >/dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null; then
              sudo npm i -g pm2
            fi

            echo "==> Installing dependencies (including dev)"
            export npm_config_production=false
            npm ci --no-audit --no-fund
            (cd frontend && npm ci --no-audit --no-fund)
            (cd backend && npm ci --no-audit --no-fund)

            echo "==> Building frontend"
            export NODE_OPTIONS="--max_old_space_size=4096"
            (cd frontend && npm run build)

            echo "==> Starting/Reloading PM2"
            APP_DIR="$APP_DIR" pm2 startOrReload ecosystem.config.js --update-env || pm2 start ecosystem.config.js --update-env
            pm2 save

            echo "==> Local health checks"
            sleep 2
            curl -fsS http://localhost:3000 >/dev/null || echo "WARN: Frontend not responding on :3000"
            curl -fsS http://localhost:3005 >/dev/null || echo "WARN: Backend not responding on :3005"

      - name: Public health checks (HTTPS)
        run: |
          set -e
          echo "==> Checking https://onelastai.co/"
          code=$(curl -k -s -o /dev/null -w "%{http_code}" --retry 4 --retry-delay 3 https://onelastai.co/);
          echo "GET / => $code"; [ "$code" = "200" ] || exit 1

          echo "==> Checking https://onelastai.co/health"
          code=$(curl -k -s -o /dev/null -w "%{http_code}" --retry 4 --retry-delay 3 https://onelastai.co/health);
          echo "GET /health => $code"; [ "$code" = "200" ] || exit 1

          echo "==> Checking https://onelastai.co/api/status"
          code=$(curl -k -s -o /dev/null -w "%{http_code}" --retry 4 --retry-delay 3 https://onelastai.co/api/status);
          echo "GET /api/status => $code"; [ "$code" = "200" ] || exit 1

            echo "==> Done"

      - name: Summary
        run: |
          echo "Deployment job triggered. Ensure repository secrets are set:"
          echo "- SSH_HOST (e.g., ec2-xx-xx-xx-xx.compute.amazonaws.com)"
          echo "- SSH_USER (e.g., ubuntu)"
          echo "- SSH_KEY (private key for the instance)"
          echo "Optional: APP_DIR (defaults to /home/ubuntu/shiny-friend-disco)"
