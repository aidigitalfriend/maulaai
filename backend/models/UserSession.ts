/**
 * User Session Model
 * Advanced session management and tracking
 */

import mongoose from 'mongoose'

const userSessionSchema = new mongoose.Schema({
  // Session Identification\n  sessionId: {\n    type: String,\n    required: true,\n    unique: true,\n    index: true\n  },\n  \n  // User Reference\n  userId: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true,\n    index: true\n  },\n  \n  // Session Type and Context\n  sessionType: {\n    type: String,\n    enum: ['web', 'mobile_app', 'desktop_app', 'api', 'webhook', 'background_job'],\n    required: true,\n    default: 'web'\n  },\n  \n  // Device and Browser Information\n  device: {\n    // Basic device info\n    type: {\n      type: String,\n      enum: ['desktop', 'mobile', 'tablet', 'smart_tv', 'gaming_console', 'iot_device', 'unknown'],\n      default: 'unknown'\n    },\n    \n    os: {\n      name: String,\n      version: String,\n      platform: String // darwin, win32, linux, etc.\n    },\n    \n    browser: {\n      name: String,\n      version: String,\n      engine: String,\n      userAgent: String\n    },\n    \n    // Device capabilities\n    capabilities: {\n      touchScreen: Boolean,\n      screenSize: {\n        width: Number,\n        height: Number,\n        density: Number\n      },\n      \n      // Feature detection\n      webgl: Boolean,\n      localStorage: Boolean,\n      cookies: Boolean,\n      javascript: Boolean\n    },\n    \n    // Device fingerprinting (for security)\n    fingerprint: {\n      canvas: String,\n      webgl: String,\n      audio: String,\n      timezone: String,\n      language: String,\n      plugins: [String],\n      fonts: [String]\n    }\n  },\n  \n  // Network and Location Information\n  network: {\n    ipAddress: {\n      type: String,\n      required: true,\n      index: true\n    },\n    \n    ipAddressV6: String,\n    \n    // Geolocation\n    location: {\n      country: String,\n      countryCode: String,\n      region: String,\n      city: String,\n      timezone: String,\n      \n      coordinates: {\n        latitude: Number,\n        longitude: Number,\n        accuracy: Number\n      },\n      \n      // ISP Information\n      isp: String,\n      organization: String,\n      asn: String\n    },\n    \n    // Connection info\n    connection: {\n      type: {\n        type: String,\n        enum: ['wifi', 'cellular', 'ethernet', 'bluetooth', 'unknown']\n      },\n      \n      speed: String, // slow-2g, 2g, 3g, 4g, 5g\n      effectiveType: String,\n      downlink: Number,\n      rtt: Number\n    }\n  },\n  \n  // Authentication Information\n  authentication: {\n    method: {\n      type: String,\n      enum: ['password', 'oauth', 'sso', 'magic_link', 'biometric', 'two_factor', 'api_key'],\n      required: true\n    },\n    \n    provider: String, // google, facebook, github, etc.\n    \n    // Two-factor authentication\n    twoFactorUsed: Boolean,\n    twoFactorMethod: String,\n    \n    // Authentication strength\n    strength: {\n      type: String,\n      enum: ['weak', 'medium', 'strong', 'very_strong'],\n      default: 'medium'\n    },\n    \n    // Session token info\n    tokenInfo: {\n      type: String, // jwt, bearer, session\n      issued: Date,\n      expires: Date,\n      refreshed: [Date]\n    }\n  },\n  \n  // Session Status\n  status: {\n    type: String,\n    enum: ['active', 'idle', 'expired', 'terminated', 'suspicious', 'locked'],\n    default: 'active',\n    index: true\n  },\n  \n  // Session Duration and Activity\n  timing: {\n    startedAt: {\n      type: Date,\n      default: Date.now,\n      required: true\n    },\n    \n    lastActivityAt: {\n      type: Date,\n      default: Date.now,\n      index: true\n    },\n    \n    endedAt: Date,\n    \n    // Duration tracking\n    totalDuration: Number, // milliseconds\n    activeDuration: Number, // milliseconds (excluding idle time)\n    idleDuration: Number, // milliseconds\n    \n    // Activity intervals\n    longestActiveSpan: Number, // milliseconds\n    longestIdleSpan: Number, // milliseconds\n    \n    // Session limits\n    maxDuration: Number, // milliseconds\n    warningThreshold: Number // milliseconds\n  },\n  \n  // Activity Tracking\n  activity: {\n    // Page/route tracking\n    pages: [{\n      path: String,\n      title: String,\n      visitedAt: { type: Date, default: Date.now },\n      duration: Number, // milliseconds\n      referrer: String,\n      \n      // Page performance\n      loadTime: Number,\n      domReady: Number,\n      firstContentfulPaint: Number\n    }],\n    \n    // Actions performed\n    actions: [{\n      type: {\n        type: String,\n        enum: ['click', 'scroll', 'form_submit', 'api_call', 'download', 'upload', 'search', 'purchase', 'other']\n      },\n      \n      target: String, // element, endpoint, etc.\n      details: mongoose.Schema.Types.Mixed,\n      timestamp: { type: Date, default: Date.now }\n    }],\n    \n    // API usage during session\n    apiCalls: {\n      total: { type: Number, default: 0 },\n      successful: { type: Number, default: 0 },\n      failed: { type: Number, default: 0 },\n      \n      // Rate limiting\n      rateLimit: {\n        remaining: Number,\n        resetAt: Date,\n        exceeded: Boolean\n      }\n    },\n    \n    // Engagement metrics\n    engagement: {\n      clickCount: { type: Number, default: 0 },\n      scrollDepth: Number, // percentage\n      timeOnPage: Number, // milliseconds\n      bounced: Boolean,\n      \n      // Feature usage\n      featuresUsed: [String],\n      \n      // User interactions\n      mouseMovements: Number,\n      keystrokes: Number,\n      touches: Number\n    }\n  },\n  \n  // Security Information\n  security: {\n    // Risk assessment\n    riskScore: {\n      type: Number,\n      min: 0,\n      max: 100,\n      default: 0\n    },\n    \n    // Security flags\n    flags: [{\n      type: {\n        type: String,\n        enum: ['suspicious_location', 'unusual_activity', 'multiple_sessions', 'bot_detected', 'vpn_detected', 'tor_detected']\n      },\n      \n      severity: {\n        type: String,\n        enum: ['low', 'medium', 'high', 'critical']\n      },\n      \n      description: String,\n      detectedAt: { type: Date, default: Date.now },\n      resolved: Boolean\n    }],\n    \n    // Anomaly detection\n    anomalies: [{\n      type: String,\n      score: Number,\n      description: String,\n      timestamp: Date,\n      \n      // Behavioral anomalies\n      behaviorPattern: String,\n      expectedPattern: String,\n      deviation: Number\n    }],\n    \n    // Concurrent sessions\n    concurrentSessions: {\n      count: { type: Number, default: 1 },\n      locations: [String],\n      suspicious: Boolean\n    },\n    \n    // Privacy settings\n    privacy: {\n      doNotTrack: Boolean,\n      cookieConsent: Boolean,\n      analyticsOptOut: Boolean,\n      \n      // GDPR compliance\n      gdprConsent: Boolean,\n      consentTimestamp: Date,\n      consentVersion: String\n    }\n  },\n  \n  // Performance Metrics\n  performance: {\n    // Network performance\n    network: {\n      latency: Number, // ms\n      bandwidth: Number, // kbps\n      packetLoss: Number, // percentage\n      \n      // CDN performance\n      cdnHits: Number,\n      cdnMisses: Number,\n      \n      // Resource loading\n      resourceLoadTime: {\n        images: Number,\n        scripts: Number,\n        stylesheets: Number,\n        fonts: Number\n      }\n    },\n    \n    // Application performance\n    application: {\n      // JavaScript performance\n      memoryUsage: Number, // MB\n      heapSize: Number, // MB\n      \n      // Rendering performance\n      fps: Number,\n      frameDrops: Number,\n      \n      // Error tracking\n      jsErrors: [{\n        message: String,\n        stack: String,\n        timestamp: Date,\n        url: String,\n        line: Number\n      }],\n      \n      // Performance marks\n      marks: [{\n        name: String,\n        timestamp: Number,\n        duration: Number\n      }]\n    }\n  },\n  \n  // Context and State\n  context: {\n    // Application state\n    currentRoute: String,\n    previousRoute: String,\n    \n    // User preferences during session\n    preferences: {\n      theme: String,\n      language: String,\n      timezone: String,\n      currency: String,\n      \n      // UI preferences\n      sidebar: String, // collapsed, expanded\n      layout: String,\n      density: String // compact, comfortable, spacious\n    },\n    \n    // Shopping cart or workspace state\n    state: {\n      cartItems: Number,\n      savedItems: Number,\n      activeProjects: Number,\n      \n      // Feature flags active during session\n      featureFlags: [{\n        flag: String,\n        enabled: Boolean,\n        variant: String\n      }]\n    },\n    \n    // A/B test participation\n    experiments: [{\n      experimentId: String,\n      variant: String,\n      startedAt: Date,\n      \n      // Conversion tracking\n      converted: Boolean,\n      conversionType: String,\n      conversionValue: Number\n    }]\n  },\n  \n  // Integration Data\n  integrations: {\n    // Analytics platforms\n    analytics: {\n      googleAnalytics: {\n        clientId: String,\n        sessionId: String\n      },\n      \n      mixpanel: {\n        distinctId: String,\n        sessionId: String\n      },\n      \n      amplitude: {\n        userId: String,\n        sessionId: String\n      }\n    },\n    \n    // Customer support\n    support: {\n      intercom: {\n        conversationId: String,\n        messageCount: Number\n      },\n      \n      zendesk: {\n        ticketId: String,\n        satisfactionRating: Number\n      }\n    },\n    \n    // Marketing tools\n    marketing: {\n      campaign: {\n        source: String,\n        medium: String,\n        campaign: String,\n        term: String,\n        content: String\n      },\n      \n      attribution: {\n        firstTouch: String,\n        lastTouch: String,\n        touchpoints: [String]\n      }\n    }\n  },\n  \n  // Session Metadata\n  metadata: {\n    // Session tags\n    tags: [String],\n    \n    // Custom data\n    customData: mongoose.Schema.Types.Mixed,\n    \n    // Session notes (for support)\n    notes: [{\n      author: String,\n      note: String,\n      timestamp: { type: Date, default: Date.now }\n    }],\n    \n    // External references\n    externalReferences: [{\n      system: String,\n      id: String,\n      type: String\n    }]\n  }\n}, {\n  timestamps: true,\n  toJSON: { virtuals: true },\n  toObject: { virtuals: true }\n})\n\n// Indexes for performance\nuserSessionSchema.index({ userId: 1, 'timing.lastActivityAt': -1 })\nuserSessionSchema.index({ sessionId: 1 }, { unique: true })\nuserSessionSchema.index({ status: 1 })\nuserSessionSchema.index({ 'network.ipAddress': 1 })\nuserSessionSchema.index({ 'timing.startedAt': -1 })\nuserSessionSchema.index({ sessionType: 1, status: 1 })\nuserSessionSchema.index({ userId: 1, status: 1, 'timing.startedAt': -1 })\n\n// TTL index for automatic cleanup of old sessions\nuserSessionSchema.index(\n  { 'timing.endedAt': 1 },\n  { \n    expireAfterSeconds: 60 * 60 * 24 * 90, // 90 days\n    partialFilterExpression: { 'timing.endedAt': { $exists: true } }\n  }\n)\n\n// Virtual for session duration\nuserSessionSchema.virtual('duration').get(function() {\n  const end = this.timing.endedAt || new Date()\n  return end - this.timing.startedAt\n})\n\n// Virtual for is active\nuserSessionSchema.virtual('isActive').get(function() {\n  return this.status === 'active'\n})\n\n// Virtual for idle time\nuserSessionSchema.virtual('idleTime').get(function() {\n  if (this.status !== 'active') return 0\n  \n  const now = new Date()\n  return now - this.timing.lastActivityAt\n})\n\n// Virtual for pages visited count\nuserSessionSchema.virtual('pagesVisited').get(function() {\n  return this.activity.pages.length\n})\n\n// Static methods\nuserSessionSchema.statics.findActive = function(userId = null) {\n  const query = { status: 'active' }\n  if (userId) query.userId = userId\n  \n  return this.find(query)\n    .sort({ 'timing.lastActivityAt': -1 })\n}\n\nuserSessionSchema.statics.findByUser = function(userId, limit = 50) {\n  return this.find({ userId })\n    .sort({ 'timing.startedAt': -1 })\n    .limit(limit)\n    .populate('userId', 'name email')\n}\n\nuserSessionSchema.statics.findConcurrent = function(userId, excludeSessionId = null) {\n  const query = {\n    userId,\n    status: 'active'\n  }\n  \n  if (excludeSessionId) {\n    query.sessionId = { $ne: excludeSessionId }\n  }\n  \n  return this.find(query)\n}\n\nuserSessionSchema.statics.getSessionStats = function(timeframe = 24) {\n  const startDate = new Date(Date.now() - timeframe * 60 * 60 * 1000)\n  \n  return this.aggregate([\n    {\n      $match: {\n        'timing.startedAt': { $gte: startDate }\n      }\n    },\n    {\n      $group: {\n        _id: {\n          hour: { $hour: '$timing.startedAt' },\n          sessionType: '$sessionType'\n        },\n        count: { $sum: 1 },\n        averageDuration: { $avg: '$timing.totalDuration' },\n        uniqueUsers: { $addToSet: '$userId' }\n      }\n    },\n    {\n      $project: {\n        hour: '$_id.hour',\n        sessionType: '$_id.sessionType',\n        count: 1,\n        averageDuration: 1,\n        uniqueUsers: { $size: '$uniqueUsers' }\n      }\n    },\n    { $sort: { hour: 1 } }\n  ])\n}\n\nuserSessionSchema.statics.findSuspicious = function() {\n  return this.find({\n    $or: [\n      { 'security.riskScore': { $gte: 70 } },\n      { 'security.flags': { $exists: true, $not: { $size: 0 } } },\n      { status: 'suspicious' }\n    ]\n  }).sort({ 'security.riskScore': -1 })\n}\n\n// Instance methods\nuserSessionSchema.methods.updateActivity = function(activityData = {}) {\n  this.timing.lastActivityAt = new Date()\n  \n  // Update total duration\n  this.timing.totalDuration = this.duration\n  \n  // Add activity if provided\n  if (activityData.type) {\n    this.activity.actions.push(activityData)\n  }\n  \n  // Update engagement metrics\n  if (activityData.type === 'click') {\n    this.activity.engagement.clickCount += 1\n  }\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.visitPage = function(path, title, loadTime) {\n  const pageVisit = {\n    path,\n    title,\n    loadTime,\n    referrer: this.context.currentRoute\n  }\n  \n  // Update previous page duration\n  const currentPage = this.activity.pages[this.activity.pages.length - 1]\n  if (currentPage && !currentPage.duration) {\n    currentPage.duration = Date.now() - currentPage.visitedAt.getTime()\n  }\n  \n  this.activity.pages.push(pageVisit)\n  this.context.previousRoute = this.context.currentRoute\n  this.context.currentRoute = path\n  \n  this.updateActivity({ type: 'page_visit', target: path })\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.endSession = function(reason = 'user_logout') {\n  this.status = 'terminated'\n  this.timing.endedAt = new Date()\n  this.timing.totalDuration = this.duration\n  \n  // Update last page duration\n  const lastPage = this.activity.pages[this.activity.pages.length - 1]\n  if (lastPage && !lastPage.duration) {\n    lastPage.duration = Date.now() - lastPage.visitedAt.getTime()\n  }\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.flagAsSuspicious = function(flagType, severity = 'medium', description) {\n  this.status = 'suspicious'\n  \n  this.security.flags.push({\n    type: flagType,\n    severity,\n    description\n  })\n  \n  // Increase risk score based on severity\n  const scoreIncrease = {\n    low: 10,\n    medium: 25,\n    high: 50,\n    critical: 75\n  }\n  \n  this.security.riskScore = Math.min(100, \n    this.security.riskScore + (scoreIncrease[severity] || 25)\n  )\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.recordApiCall = function(success = true) {\n  this.activity.apiCalls.total += 1\n  \n  if (success) {\n    this.activity.apiCalls.successful += 1\n  } else {\n    this.activity.apiCalls.failed += 1\n  }\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.updatePerformance = function(performanceData) {\n  // Update network performance\n  if (performanceData.network) {\n    Object.assign(this.performance.network, performanceData.network)\n  }\n  \n  // Update application performance\n  if (performanceData.application) {\n    Object.assign(this.performance.application, performanceData.application)\n  }\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.addJSError = function(error) {\n  this.performance.application.jsErrors.push({\n    message: error.message,\n    stack: error.stack,\n    url: error.url,\n    line: error.line,\n    timestamp: new Date()\n  })\n  \n  // Increase risk score for frequent errors\n  if (this.performance.application.jsErrors.length > 10) {\n    this.security.riskScore = Math.min(100, this.security.riskScore + 5)\n  }\n  \n  return this.save()\n}\n\nuserSessionSchema.methods.checkForAnomalies = function() {\n  const anomalies = []\n  \n  // Check for unusual activity patterns\n  const avgPageTime = this.activity.pages.reduce((sum, page) => \n    sum + (page.duration || 0), 0) / this.activity.pages.length\n  \n  if (avgPageTime > 30 * 60 * 1000) { // More than 30 minutes per page\n    anomalies.push({\n      type: 'unusual_page_time',\n      score: 0.7,\n      description: 'Unusually long time spent on pages',\n      timestamp: new Date()\n    })\n  }\n  \n  // Check for rapid navigation\n  if (this.activity.pages.length > 50 && this.duration < 5 * 60 * 1000) {\n    anomalies.push({\n      type: 'rapid_navigation',\n      score: 0.8,\n      description: 'Unusually rapid page navigation',\n      timestamp: new Date()\n    })\n  }\n  \n  // Check API call patterns\n  const apiFailureRate = this.activity.apiCalls.failed / \n    Math.max(1, this.activity.apiCalls.total)\n  \n  if (apiFailureRate > 0.5) {\n    anomalies.push({\n      type: 'high_api_failure_rate',\n      score: 0.6,\n      description: 'High API failure rate detected',\n      timestamp: new Date()\n    })\n  }\n  \n  this.security.anomalies.push(...anomalies)\n  \n  // Update risk score based on anomalies\n  const anomalyScore = anomalies.reduce((sum, a) => sum + a.score, 0) * 10\n  this.security.riskScore = Math.min(100, this.security.riskScore + anomalyScore)\n  \n  return this.save()\n}\n\n// Pre-save middleware\nuserSessionSchema.pre('save', function(next) {\n  // Generate session ID if new\n  if (this.isNew && !this.sessionId) {\n    this.sessionId = `sess_${Date.now()}_${Math.random().toString(36).substr(2, 12)}`\n  }\n  \n  // Update activity durations\n  if (this.timing.startedAt && this.timing.lastActivityAt) {\n    const totalTime = (this.timing.endedAt || new Date()) - this.timing.startedAt\n    const activeTime = this.timing.lastActivityAt - this.timing.startedAt\n    \n    this.timing.totalDuration = totalTime\n    this.timing.activeDuration = activeTime\n    this.timing.idleDuration = totalTime - activeTime\n  }\n  \n  // Auto-expire idle sessions\n  const maxIdleTime = 30 * 60 * 1000 // 30 minutes\n  if (this.status === 'active' && this.idleTime > maxIdleTime) {\n    this.status = 'idle'\n  }\n  \n  next()\n})\n\nexport default mongoose.models.UserSession || mongoose.model('UserSession', userSessionSchema, 'sessions')"