/**
 * User Preferences Model
 * Comprehensive user preferences and settings management
 */

import mongoose from 'mongoose'

const userPreferencesSchema = new mongoose.Schema({
  // User Reference
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    unique: true,
    index: true
  },
  
  // General Preferences
  general: {\n    // Language and Localization\n    language: {\n      primary: {\n        type: String,\n        default: 'en',\n        match: /^[a-z]{2}(-[A-Z]{2})?$/ // ISO 639-1 format\n      },\n      \n      secondary: [String], // Additional languages\n      \n      // Regional settings\n      region: {\n        type: String,\n        default: 'US'\n      },\n      \n      dateFormat: {\n        type: String,\n        enum: ['MM/DD/YYYY', 'DD/MM/YYYY', 'YYYY-MM-DD', 'DD MMM YYYY'],\n        default: 'MM/DD/YYYY'\n      },\n      \n      timeFormat: {\n        type: String,\n        enum: ['12h', '24h'],\n        default: '12h'\n      },\n      \n      numberFormat: {\n        decimalSeparator: { type: String, default: '.' },\n        thousandsSeparator: { type: String, default: ',' },\n        currency: { type: String, default: 'USD' }\n      }\n    },\n    \n    // Timezone Settings\n    timezone: {\n      name: {\n        type: String,\n        default: 'America/New_York'\n      },\n      \n      offset: {\n        type: Number, // UTC offset in minutes\n        default: -300 // EST\n      },\n      \n      autoDetect: {\n        type: Boolean,\n        default: true\n      }\n    },\n    \n    // Currency Preferences\n    currency: {\n      primary: {\n        type: String,\n        default: 'USD',\n        maxlength: 3\n      },\n      \n      display: {\n        symbol: { type: String, default: '$' },\n        position: { type: String, enum: ['before', 'after'], default: 'before' },\n        decimals: { type: Number, min: 0, max: 4, default: 2 }\n      },\n      \n      // Exchange rates (if supporting multiple currencies)\n      exchangeRates: [{\n        currency: String,\n        rate: Number,\n        lastUpdated: Date\n      }]\n    }\n  },\n  \n  // UI/UX Preferences\n  interface: {\n    // Theme Settings\n    theme: {\n      mode: {\n        type: String,\n        enum: ['light', 'dark', 'auto', 'system'],\n        default: 'auto'\n      },\n      \n      colorScheme: {\n        type: String,\n        enum: ['blue', 'green', 'purple', 'red', 'orange', 'custom'],\n        default: 'blue'\n      },\n      \n      customColors: {\n        primary: String,\n        secondary: String,\n        accent: String,\n        background: String\n      },\n      \n      // Accessibility\n      highContrast: { type: Boolean, default: false },\n      reducedMotion: { type: Boolean, default: false },\n      fontSize: {\n        type: String,\n        enum: ['small', 'medium', 'large', 'extra-large'],\n        default: 'medium'\n      }\n    },\n    \n    // Layout Preferences\n    layout: {\n      sidebar: {\n        position: { type: String, enum: ['left', 'right'], default: 'left' },\n        collapsed: { type: Boolean, default: false },\n        pinned: { type: Boolean, default: true }\n      },\n      \n      density: {\n        type: String,\n        enum: ['compact', 'comfortable', 'spacious'],\n        default: 'comfortable'\n      },\n      \n      gridView: {\n        itemsPerRow: { type: Number, min: 1, max: 12, default: 3 },\n        showThumbnails: { type: Boolean, default: true },\n        showDetails: { type: Boolean, default: true }\n      },\n      \n      // Dashboard customization\n      dashboard: {\n        widgets: [{\n          widgetId: String,\n          position: {\n            x: Number,\n            y: Number,\n            width: Number,\n            height: Number\n          },\n          visible: { type: Boolean, default: true },\n          settings: mongoose.Schema.Types.Mixed\n        }],\n        \n        layout: { type: String, default: 'grid' },\n        autoRefresh: { type: Boolean, default: false },\n        refreshInterval: { type: Number, default: 300 } // seconds\n      }\n    },\n    \n    // Navigation Preferences\n    navigation: {\n      defaultPage: String, // page to load on login\n      breadcrumbs: { type: Boolean, default: true },\n      quickLinks: [{\n        label: String,\n        url: String,\n        icon: String,\n        order: Number\n      }],\n      \n      // Keyboard shortcuts\n      shortcuts: {\n        enabled: { type: Boolean, default: true },\n        custom: [{\n          action: String,\n          keyCombo: String,\n          description: String\n        }]\n      }\n    }\n  },\n  \n  // Privacy Settings\n  privacy: {\n    // Data Collection\n    dataCollection: {\n      analytics: { type: Boolean, default: true },\n      cookies: { type: Boolean, default: true },\n      tracking: { type: Boolean, default: false },\n      personalizedAds: { type: Boolean, default: false },\n      \n      // Detailed preferences\n      functionalCookies: { type: Boolean, default: true },\n      performanceCookies: { type: Boolean, default: true },\n      targetingCookies: { type: Boolean, default: false }\n    },\n    \n    // Profile Visibility\n    profileVisibility: {\n      profile: {\n        type: String,\n        enum: ['public', 'friends', 'private'],\n        default: 'friends'\n      },\n      \n      email: {\n        type: String,\n        enum: ['public', 'friends', 'private'],\n        default: 'private'\n      },\n      \n      activity: {\n        type: String,\n        enum: ['public', 'friends', 'private'],\n        default: 'friends'\n      },\n      \n      location: {\n        type: String,\n        enum: ['public', 'friends', 'private'],\n        default: 'private'\n      }\n    },\n    \n    // Search and Discovery\n    searchability: {\n      findByEmail: { type: Boolean, default: false },\n      findByPhone: { type: Boolean, default: false },\n      searchEngines: { type: Boolean, default: false },\n      suggestions: { type: Boolean, default: true }\n    },\n    \n    // Data Management\n    dataRetention: {\n      deleteInactiveData: { type: Boolean, default: false },\n      retentionPeriod: { type: Number, default: 365 }, // days\n      autoDelete: { type: Boolean, default: false }\n    }\n  },\n  \n  // Communication Preferences\n  communications: {\n    // Email Settings\n    email: {\n      enabled: { type: Boolean, default: true },\n      \n      // Notification types\n      notifications: {\n        account: { type: Boolean, default: true },\n        security: { type: Boolean, default: true },\n        product: { type: Boolean, default: true },\n        marketing: { type: Boolean, default: false },\n        newsletter: { type: Boolean, default: false },\n        tips: { type: Boolean, default: true }\n      },\n      \n      // Frequency settings\n      frequency: {\n        type: String,\n        enum: ['immediate', 'daily', 'weekly', 'monthly', 'never'],\n        default: 'immediate'\n      },\n      \n      // Digest settings\n      digest: {\n        enabled: { type: Boolean, default: false },\n        frequency: { type: String, enum: ['daily', 'weekly'], default: 'weekly' },\n        time: { type: String, default: '09:00' }, // HH:MM format\n        dayOfWeek: { type: Number, min: 0, max: 6, default: 1 } // 0=Sunday\n      }\n    },\n    \n    // SMS/Text Settings\n    sms: {\n      enabled: { type: Boolean, default: false },\n      \n      notifications: {\n        security: { type: Boolean, default: true },\n        urgent: { type: Boolean, default: true },\n        reminders: { type: Boolean, default: false },\n        marketing: { type: Boolean, default: false }\n      },\n      \n      // Quiet hours\n      quietHours: {\n        enabled: { type: Boolean, default: true },\n        start: { type: String, default: '22:00' },\n        end: { type: String, default: '08:00' }\n      }\n    },\n    \n    // Push Notifications\n    push: {\n      enabled: { type: Boolean, default: true },\n      \n      notifications: {\n        messages: { type: Boolean, default: true },\n        updates: { type: Boolean, default: true },\n        reminders: { type: Boolean, default: true },\n        social: { type: Boolean, default: false },\n        marketing: { type: Boolean, default: false }\n      },\n      \n      sound: { type: Boolean, default: true },\n      vibration: { type: Boolean, default: true },\n      badge: { type: Boolean, default: true }\n    },\n    \n    // In-app Notifications\n    inApp: {\n      enabled: { type: Boolean, default: true },\n      \n      position: {\n        type: String,\n        enum: ['top-right', 'top-left', 'bottom-right', 'bottom-left'],\n        default: 'top-right'\n      },\n      \n      duration: { type: Number, default: 5000 }, // milliseconds\n      \n      types: {\n        success: { type: Boolean, default: true },\n        warning: { type: Boolean, default: true },\n        error: { type: Boolean, default: true },\n        info: { type: Boolean, default: true }\n      }\n    }\n  },\n  \n  // AI and Personalization\n  ai: {\n    // AI Features\n    features: {\n      recommendations: { type: Boolean, default: true },\n      autoComplete: { type: Boolean, default: true },\n      smartSearch: { type: Boolean, default: true },\n      contentGeneration: { type: Boolean, default: false },\n      voiceAssistant: { type: Boolean, default: false }\n    },\n    \n    // Personalization Level\n    personalization: {\n      level: {\n        type: String,\n        enum: ['none', 'basic', 'enhanced', 'maximum'],\n        default: 'basic'\n      },\n      \n      dataUsage: {\n        browsing: { type: Boolean, default: true },\n        purchases: { type: Boolean, default: true },\n        social: { type: Boolean, default: false },\n        location: { type: Boolean, default: false }\n      }\n    },\n    \n    // Model Preferences\n    models: {\n      textGeneration: {\n        type: String,\n        enum: ['gpt-4', 'gpt-3.5', 'claude-3-sonnet', 'gemini-pro'],\n        default: 'gpt-4'\n      },\n      \n      imageGeneration: {\n        type: String,\n        enum: ['dall-e-3', 'midjourney', 'stable-diffusion'],\n        default: 'dall-e-3'\n      },\n      \n      // Generation settings\n      creativity: { type: Number, min: 0, max: 1, default: 0.7 },\n      safety: { type: Number, min: 0, max: 1, default: 0.8 }\n    },\n    \n    // Learning Preferences\n    learning: {\n      adaptToUsage: { type: Boolean, default: true },\n      explainDecisions: { type: Boolean, default: false },\n      askForFeedback: { type: Boolean, default: true },\n      \n      // Content filtering\n      contentFilter: {\n        enabled: { type: Boolean, default: true },\n        level: {\n          type: String,\n          enum: ['strict', 'moderate', 'permissive'],\n          default: 'moderate'\n        }\n      }\n    }\n  },\n  \n  // Security Preferences\n  security: {\n    // Authentication\n    authentication: {\n      twoFactor: {\n        enabled: { type: Boolean, default: false },\n        method: {\n          type: String,\n          enum: ['sms', 'email', 'app', 'hardware'],\n          default: 'app'\n        },\n        backupCodes: { type: Boolean, default: true }\n      },\n      \n      sessionManagement: {\n        rememberDevice: { type: Boolean, default: false },\n        sessionTimeout: { type: Number, default: 30 }, // minutes\n        concurrentSessions: { type: Number, default: 3 },\n        logoutOtherSessions: { type: Boolean, default: false }\n      },\n      \n      // Password preferences\n      password: {\n        requireChange: { type: Number, default: 0 }, // days, 0 = never\n        complexity: {\n          type: String,\n          enum: ['basic', 'medium', 'strong'],\n          default: 'medium'\n        }\n      }\n    },\n    \n    // Activity Monitoring\n    monitoring: {\n      loginAlerts: { type: Boolean, default: true },\n      suspiciousActivity: { type: Boolean, default: true },\n      dataAccess: { type: Boolean, default: false },\n      \n      // Alert preferences\n      alertMethods: [{\n        type: { type: String, enum: ['email', 'sms', 'push'] },\n        enabled: { type: Boolean, default: true }\n      }]\n    }\n  },\n  \n  // Application-Specific Preferences\n  applicationSettings: {\n    // Feature preferences\n    features: [{\n      featureId: String,\n      enabled: { type: Boolean, default: true },\n      settings: mongoose.Schema.Types.Mixed,\n      lastModified: { type: Date, default: Date.now }\n    }],\n    \n    // Workspace settings\n    workspace: {\n      defaultProject: String,\n      autoSave: { type: Boolean, default: true },\n      autoSaveInterval: { type: Number, default: 30 }, // seconds\n      \n      // Collaboration\n      collaboration: {\n        shareByDefault: { type: Boolean, default: false },\n        allowComments: { type: Boolean, default: true },\n        showPresence: { type: Boolean, default: true }\n      }\n    },\n    \n    // Integration settings\n    integrations: [{\n      service: String,\n      enabled: { type: Boolean, default: true },\n      settings: mongoose.Schema.Types.Mixed,\n      credentials: mongoose.Schema.Types.Mixed, // Should be encrypted\n      lastSync: Date\n    }]\n  },\n  \n  // Experimental Features\n  experiments: {\n    // Beta features\n    betaFeatures: {\n      enabled: { type: Boolean, default: false },\n      features: [String] // Array of beta feature IDs\n    },\n    \n    // A/B testing\n    testing: {\n      participateInTests: { type: Boolean, default: true },\n      currentTests: [{\n        testId: String,\n        variant: String,\n        startedAt: Date,\n        feedback: String\n      }]\n    },\n    \n    // Feedback and surveys\n    feedback: {\n      enableSurveys: { type: Boolean, default: true },\n      surveyFrequency: {\n        type: String,\n        enum: ['never', 'rare', 'occasional', 'frequent'],\n        default: 'occasional'\n      }\n    }\n  },\n  \n  // Metadata\n  metadata: {\n    version: { type: Number, default: 1 },\n    lastUpdated: { type: Date, default: Date.now },\n    migrationHistory: [{\n      fromVersion: Number,\n      toVersion: Number,\n      migratedAt: Date,\n      changes: [String]\n    }],\n    \n    // Backup and sync\n    backup: {\n      lastBackup: Date,\n      cloudSync: { type: Boolean, default: true },\n      conflictResolution: {\n        type: String,\n        enum: ['server_wins', 'client_wins', 'manual'],\n        default: 'server_wins'\n      }\n    }\n  }\n}, {\n  timestamps: true,\n  toJSON: { \n    virtuals: true,\n    transform: function(doc, ret) {\n      // Remove sensitive data from JSON output\n      if (ret.applicationSettings?.integrations) {\n        ret.applicationSettings.integrations = ret.applicationSettings.integrations.map(integration => {\n          const { credentials, ...safeIntegration } = integration\n          return safeIntegration\n        })\n      }\n      return ret\n    }\n  },\n  toObject: { virtuals: true }\n})\n\n// Indexes\nuserPreferencesSchema.index({ userId: 1 }, { unique: true })\n\n// Virtual for theme preference\nuserPreferencesSchema.virtual('currentTheme').get(function() {\n  if (this.interface?.theme?.mode === 'auto' || this.interface?.theme?.mode === 'system') {\n    const hour = new Date().getHours()\n    return (hour >= 6 && hour < 18) ? 'light' : 'dark'\n  }\n  return this.interface?.theme?.mode || 'light'\n})\n\n// Virtual for effective language\nuserPreferencesSchema.virtual('effectiveLanguage').get(function() {\n  return this.general?.language?.primary || 'en'\n})\n\n// Virtual for notification preferences summary\nuserPreferencesSchema.virtual('notificationSummary').get(function() {\n  return {\n    email: this.communications?.email?.enabled || false,\n    sms: this.communications?.sms?.enabled || false,\n    push: this.communications?.push?.enabled || false,\n    inApp: this.communications?.inApp?.enabled || false\n  }\n})\n\n// Static methods\nuserPreferencesSchema.statics.getDefaults = function() {\n  // Return default preferences object\n  return {\n    general: {\n      language: { primary: 'en' },\n      timezone: { name: 'America/New_York', autoDetect: true },\n      currency: { primary: 'USD' }\n    },\n    interface: {\n      theme: { mode: 'auto', colorScheme: 'blue' },\n      layout: { density: 'comfortable' }\n    },\n    privacy: {\n      dataCollection: { analytics: true, cookies: true }\n    },\n    communications: {\n      email: { enabled: true, notifications: { security: true } },\n      push: { enabled: true }\n    },\n    ai: {\n      features: { recommendations: true },\n      personalization: { level: 'basic' }\n    }\n  }\n}\n\nuserPreferencesSchema.statics.findByUser = function(userId) {\n  return this.findOne({ userId })\n}\n\nuserPreferencesSchema.statics.createDefault = function(userId) {\n  const defaults = this.getDefaults()\n  return this.create({ userId, ...defaults })\n}\n\n// Instance methods\nuserPreferencesSchema.methods.updatePreference = function(path, value) {\n  // Safely update nested preference\n  const pathArray = path.split('.')\n  let current = this\n  \n  for (let i = 0; i < pathArray.length - 1; i++) {\n    const key = pathArray[i]\n    if (!current[key]) {\n      current[key] = {}\n    }\n    current = current[key]\n  }\n  \n  current[pathArray[pathArray.length - 1]] = value\n  this.metadata.lastUpdated = new Date()\n  \n  return this.save()\n}\n\nuserPreferencesSchema.methods.resetToDefaults = function() {\n  const defaults = this.constructor.getDefaults()\n  Object.assign(this, defaults)\n  \n  this.metadata.version += 1\n  this.metadata.lastUpdated = new Date()\n  \n  return this.save()\n}\n\nuserPreferencesSchema.methods.exportPreferences = function() {\n  // Export preferences for backup or migration\n  const exported = this.toObject()\n  \n  // Remove sensitive data\n  if (exported.applicationSettings?.integrations) {\n    exported.applicationSettings.integrations = exported.applicationSettings.integrations.map(integration => {\n      const { credentials, ...safeIntegration } = integration\n      return safeIntegration\n    })\n  }\n  \n  return exported\n}\n\nuserPreferencesSchema.methods.importPreferences = function(importedPrefs) {\n  // Safely import preferences, preserving userId and metadata\n  const { userId, metadata, ...prefs } = importedPrefs\n  \n  Object.assign(this, prefs)\n  \n  this.metadata.version += 1\n  this.metadata.lastUpdated = new Date()\n  \n  return this.save()\n}\n\nuserPreferencesSchema.methods.getNotificationSettings = function() {\n  return {\n    email: {\n      enabled: this.communications?.email?.enabled || false,\n      types: this.communications?.email?.notifications || {},\n      frequency: this.communications?.email?.frequency || 'immediate'\n    },\n    sms: {\n      enabled: this.communications?.sms?.enabled || false,\n      types: this.communications?.sms?.notifications || {}\n    },\n    push: {\n      enabled: this.communications?.push?.enabled || false,\n      types: this.communications?.push?.notifications || {}\n    },\n    inApp: {\n      enabled: this.communications?.inApp?.enabled || false,\n      settings: {\n        position: this.communications?.inApp?.position || 'top-right',\n        duration: this.communications?.inApp?.duration || 5000\n      }\n    }\n  }\n}\n\nuserPreferencesSchema.methods.updateTheme = function(mode, colorScheme, customColors) {\n  if (!this.interface) this.interface = {}\n  if (!this.interface.theme) this.interface.theme = {}\n  \n  if (mode) this.interface.theme.mode = mode\n  if (colorScheme) this.interface.theme.colorScheme = colorScheme\n  if (customColors) this.interface.theme.customColors = customColors\n  \n  this.metadata.lastUpdated = new Date()\n  \n  return this.save()\n}\n\nuserPreferencesSchema.methods.enableBetaFeature = function(featureId) {\n  if (!this.experiments) this.experiments = {}\n  if (!this.experiments.betaFeatures) {\n    this.experiments.betaFeatures = { enabled: true, features: [] }\n  }\n  \n  if (!this.experiments.betaFeatures.features.includes(featureId)) {\n    this.experiments.betaFeatures.features.push(featureId)\n    this.experiments.betaFeatures.enabled = true\n  }\n  \n  return this.save()\n}\n\nuserPreferencesSchema.methods.disableBetaFeature = function(featureId) {\n  if (this.experiments?.betaFeatures?.features) {\n    this.experiments.betaFeatures.features = \n      this.experiments.betaFeatures.features.filter(id => id !== featureId)\n    \n    // Disable beta features entirely if no features are enabled\n    if (this.experiments.betaFeatures.features.length === 0) {\n      this.experiments.betaFeatures.enabled = false\n    }\n  }\n  \n  return this.save()\n}\n\n// Pre-save middleware\nuserPreferencesSchema.pre('save', function(next) {\n  // Update metadata\n  this.metadata.lastUpdated = new Date()\n  \n  // Validate timezone\n  if (this.general?.timezone?.name && this.isModified('general.timezone.name')) {\n    // This would typically validate against a list of valid timezones\n    // For now, we'll just check it's not empty\n    if (!this.general.timezone.name.trim()) {\n      this.general.timezone.name = 'UTC'\n    }\n  }\n  \n  // Ensure notification settings are consistent\n  if (this.communications?.email?.enabled === false) {\n    // Disable all email notifications if email is disabled\n    if (this.communications.email.notifications) {\n      Object.keys(this.communications.email.notifications).forEach(key => {\n        this.communications.email.notifications[key] = false\n      })\n    }\n  }\n  \n  next()\n})\n\nexport default mongoose.model('UserPreferences', userPreferencesSchema)"